<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Chandu Fitness Admin</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  
  <style>
    :root { --primary: #ff3b3b; --bg: #000000; --card-bg: #121212; --border: #222; --text: #ffffff; --text-muted: #888888; --success: #00ff88; --warning: #ffb700; }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: var(--text); font-family: 'Montserrat', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
    
    /* Login & Modal Styles */
    #login-overlay { position: fixed; inset: 0; background: radial-gradient(circle at center, #1a0505 0%, #000 70%); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .login-box { background: rgba(20, 20, 20, 0.9); border: 1px solid var(--border); padding: 40px; border-radius: 24px; text-align: center; width: 85%; max-width: 340px; backdrop-filter: blur(10px); }
    .login-logo { font-family: 'Oswald', sans-serif; font-size: 2rem; color: white; margin-bottom: 5px; }
    .login-logo span { color: var(--primary); }
    .pin-input { width: 100%; padding: 15px; margin: 30px 0; background: #000; border: 1px solid #333; color: #fff; text-align: center; font-size: 1.8rem; letter-spacing: 10px; border-radius: 12px; outline: none; }
    .btn-main { width: 100%; padding: 16px; background: var(--primary); color: #fff; border: none; border-radius: 12px; font-weight: 700; font-family: 'Oswald', sans-serif; font-size: 1.1rem; cursor: pointer; }

    /* Header */
    .header { position: sticky; top: 0; z-index: 100; background: rgba(5, 5, 5, 0.85); backdrop-filter: blur(12px); padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; }
    .logo-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
    .app-logo { font-family: 'Oswald', sans-serif; font-size: 1.3rem; font-weight: 600; color: white; display: flex; align-items: center; gap: 10px; }
    .badge-admin { background: #222; color: #888; font-size: 0.6rem; padding: 4px 8px; border-radius: 6px; font-weight: 700; border: 1px solid #333; }
    .search-bar { width: 100%; padding: 14px 16px; border-radius: 14px; border: 1px solid #333; background: #111; color: white; outline: none; }

    /* Tabs */
    .tabs { display: flex; background: #111; padding: 4px; border-radius: 12px; border: 1px solid #333; }
    .tab { flex: 1; text-align: center; padding: 10px; font-size: 0.85rem; font-weight: 600; color: #666; cursor: pointer; border-radius: 8px; transition: 0.3s; position: relative; }
    .tab.active { background: #222; color: white; border: 1px solid #333; }
    .notif-badge { position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; background: var(--primary); border-radius: 50%; display: none; }

    .filters { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
    .filter-chip { padding: 8px 16px; background: #151515; border: 1px solid #333; border-radius: 20px; color: #888; font-size: 0.8rem; font-weight: 600; white-space: nowrap; cursor: pointer; }
    .filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* Content */
    .content-wrapper { flex: 1; padding: 20px 20px 80px; }
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px; }
    .stat-card { background: #0f0f0f; padding: 16px; border-radius: 16px; text-align: center; border: 1px solid var(--border); }
    .stat-val { font-family: 'Oswald', sans-serif; font-size: 1.4rem; font-weight: 600; color: white; }
    .stat-label { font-size: 0.65rem; color: #666; text-transform: uppercase; font-weight: 600; }

    /* Table Styles */
    table { width: 100%; border-collapse: separate; border-spacing: 0 12px; }
    tbody tr { background: var(--card-bg); }
    tbody td { padding: 16px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); color: #ccc; font-size: 0.95rem; }
    tbody tr td:first-child { border-left: 1px solid var(--border); border-top-left-radius: 14px; border-bottom-left-radius: 14px; }
    tbody tr td:last-child { border-right: 1px solid var(--border); border-top-right-radius: 14px; border-bottom-right-radius: 14px; }
    
    /* Buttons */
    .btn-wa { display: flex; align-items: center; justify-content: center; width: 42px; height: 42px; background: rgba(37, 211, 102, 0.1); border-radius: 12px; color: #25d366; font-size: 1.4rem; border: 1px solid rgba(37, 211, 102, 0.2); }
    .action-group { display: flex; gap: 8px; justify-content: flex-end; }
    .btn-icon { width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #333; background: #1a1a1a; color: #888; }
    
    .btn-approve { color: #00ff88; border-color: #00ff88; background: rgba(0, 255, 136, 0.1); }
    .btn-reject { color: #ff3b3b; border-color: #ff3b3b; background: rgba(255, 59, 59, 0.1); }

    /* Mobile Cards */
    @media (max-width: 768px) {
      thead { display: none; }
      tr { display: block; margin-bottom: 16px; border-radius: 18px; position: relative; border: 1px solid #222; padding: 18px; background: #111; }
      td { display: block; padding: 0; border: none !important; }
      
      /* Dashboard */
      .dash-view td:nth-child(2) { font-size: 1.25rem; font-weight: 700; color: white; font-family: 'Oswald', sans-serif; }
      .dash-view td:nth-child(3) { color: #666; font-size: 0.9rem; margin-bottom: 10px; }
      .dash-view td:nth-child(4) { display: inline-block; background: #1a1a1a; padding: 4px 10px; border-radius: 6px; color: var(--primary); font-size: 0.8rem; font-weight: 600; border: 1px solid #222; }
      .dash-view td:nth-child(5) { margin-top: 12px; }
      .dash-view td:nth-child(1) { position: absolute; top: 18px; right: 70px; font-size: 0.75rem; color: #555; font-weight: 600; }
      .dash-view td:nth-child(6) { position: absolute; top: 15px; right: 15px; }
      
      /* History/Requests */
      .hist-view td:nth-child(2) { font-size: 1.1rem; font-weight: 700; color: white; }
      .hist-view td:nth-child(4) { color: #888; font-size: 0.85rem; margin-bottom: 10px; display:block; }
      .hist-view td:nth-child(5) { color: var(--success); font-weight:bold; }
      .hist-view td:nth-child(1) { color: #444; font-size: 0.75rem; margin-bottom: 5px; display: block; }
      .hist-view td:nth-child(6) { position: absolute; top: 18px; right: 15px; }
    }
    
    .badge { padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; display: inline-block; text-transform: uppercase; }
    .b-active { background: rgba(0,255,136,0.1); color: #00ff88; border: 1px solid rgba(0,255,136,0.15); }
    .b-soon { background: rgba(255,183,0,0.1); color: #ffb700; border: 1px solid rgba(255,183,0,0.15); }
    .b-expired { background: rgba(255,59,59,0.1); color: #ff3b3b; border: 1px solid rgba(255,59,59,0.15); }
    
    /* Edit Modal */
    #edit-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 99999; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .edit-box { background: #111; width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; border: 1px solid #333; }
    .edit-field { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
  </style>
</head>
<body>

  <div id="login-overlay">
    <div class="login-box">
      <div class="login-logo">CHANDU<span>FITNESS</span></div>
      <p style="color:#666; font-size:0.8rem; margin-bottom:20px; font-weight:600;">SECURE ADMIN PANEL</p>
      <input type="password" id="pin-input" class="pin-input" placeholder="••••" maxlength="4" inputmode="numeric">
      <button class="btn-main" onclick="Auth.login()">ACCESS DASHBOARD</button>
      <p id="error-msg" style="color:var(--primary); margin-top:20px; font-size:0.9rem; display:none">Incorrect PIN</p>
    </div>
  </div>

  <div id="edit-modal">
    <div class="edit-box">
       <h3 style="color:white; margin-bottom:20px; font-family:'Oswald',sans-serif;">EDIT MEMBER</h3>
       <input type="hidden" id="edit-row">
       <input type="text" id="edit-name" class="edit-field" placeholder="Name">
       <input type="number" id="edit-phone" class="edit-field" placeholder="Phone">
       <input type="text" id="edit-plan" class="edit-field" placeholder="Plan">
       <input type="number" id="edit-amount" class="edit-field" placeholder="Amount">
       <div style="display:flex; gap:10px;">
           <button class="btn-main" style="background:#222;" onclick="document.getElementById('edit-modal').style.display='none'">CANCEL</button>
           <button class="btn-main" onclick="App.saveEdit()">SAVE</button>
       </div>
    </div>
  </div>

  <div class="main">
    <header class="header">
      <div class="logo-bar">
        <div class="app-logo"><i class="fas fa-dumbbell"></i> CHANDHU FITNESS</div>
        <div class="badge-admin">ADMIN</div>
      </div>
      
      <input id="search" class="search-bar" placeholder="Search members..." oninput="App.search()"/>
      
      <div class="tabs">
        <div class="tab active" onclick="App.setMode('dashboard', this)">Dashboard</div>
        <div class="tab" onclick="App.setMode('requests', this)">Requests <div id="req-dot" class="notif-badge"></div></div>
        <div class="tab" onclick="App.setMode('history', this)">History</div>
      </div>

      <div id="filters-container" class="filters">
        <div class="filter-chip active" onclick="App.filter('all', this)">All</div>
        <div class="filter-chip" onclick="App.filter('active', this)">Active</div>
        <div class="filter-chip" onclick="App.filter('soon', this)">Expiring Soon</div>
        <div class="filter-chip" onclick="App.filter('expired', this)">Expired</div>
      </div>
    </header>

    <div class="content-wrapper">
      <div id="stats-container" class="stats">
        <div class="stat-card"><div class="stat-val" style="color:var(--primary)">₹<span id="stat-revenue">0</span></div><div class="stat-label">Revenue</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-total">0</div><div class="stat-label">Members</div></div>
        <div class="stat-card"><div class="stat-val" style="color:var(--warning)" id="stat-pending">0</div><div class="stat-label">Pending</div></div>
      </div>

      <div id="loader" style="text-align:center; padding:60px; color:#444;">
        <i class="fas fa-circle-notch fa-spin fa-2x"></i><br><br>Syncing Database...
      </div>

      <table id="data-table" style="display:none">
        <thead id="table-head"></thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </div>

<script>
// --- CONFIGURATION ---
const CONFIG = {
    // ⚠️ PASTE YOUR NEW WEB APP URL HERE
    API_URL: "https://script.google.com/macros/s/AKfycbwNGxdDIqJdUZFwya2fwijTm4m-ASk1XJvBQd93BsM2jBMWADhs81x2TpHdPJndoHualw/exec",
    PIN_HASH: "03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4"
};

let APPROVED_DATA = []; 
let PENDING_DATA = [];
let CURRENT_MODE = 'dashboard'; 
let CURRENT_FILTER = 'all';

// --- AUTH SYSTEM ---
const Auth = {
    async login() {
        const input = document.getElementById('pin-input').value;
        const hash = await this.sha256(input);
        if(hash === CONFIG.PIN_HASH) {
            document.getElementById('login-overlay').style.display = 'none';
            App.fetchData();
        } else {
            document.getElementById('error-msg').style.display = 'block';
        }
    },
    async sha256(str) {
        const buf = new TextEncoder().encode(str);
        const hash = await crypto.subtle.digest('SHA-256', buf);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
    }
};

// --- APP LOGIC ---
const App = {
  fetchData() {
    document.getElementById("loader").style.display = "block";
    document.getElementById("data-table").style.display = "none";
    
    fetch(CONFIG.API_URL)
      .then(r => r.json())
      .then(data => {
        // 1. APPROVED DATA
        if (data.approved) {
           APPROVED_DATA = data.approved.map((r, i) => ({
              date: r[0], name: r[1], phone: r[2] ? String(r[2]) : "", 
              plan: r[3], amount: parseInt(r[4]) || 0, days: parseInt(r[7]) || 0, 
              rowIndex: i + 2 
           }));
           APPROVED_DATA.sort((a,b) => new Date(b.date) - new Date(a.date));
        }

        // 2. PENDING DATA
        if (data.pending) {
           PENDING_DATA = data.pending.map((r, i) => ({
                date: r[0], name: r[1], phone: r[2], plan: r[3], amount: r[4], 
                rowIndex: i + 2 
           }));
        }

        this.updateStats();
        this.render();
        document.getElementById("loader").style.display = "none";
        document.getElementById("data-table").style.display = "table";
      });
  },

  updateStats() {
    const uniqueMap = new Map();
    APPROVED_DATA.forEach(i => uniqueMap.set(i.phone, true));
    
    document.getElementById("stat-revenue").innerText = APPROVED_DATA.reduce((s, i) => s + i.amount, 0).toLocaleString();
    document.getElementById("stat-total").innerText = uniqueMap.size;
    document.getElementById("stat-pending").innerText = PENDING_DATA.length;
    document.getElementById("req-dot").style.display = PENDING_DATA.length > 0 ? 'block' : 'none';
  },

  setMode(mode, btn) {
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    btn.classList.add('active');
    CURRENT_MODE = mode;
    
    document.getElementById('stats-container').style.display = (mode === 'dashboard') ? 'grid' : 'none';
    document.getElementById('filters-container').style.display = (mode === 'dashboard') ? 'flex' : 'none';
    
    this.render();
  },

  filter(type, btn) {
    if(CURRENT_MODE !== 'dashboard') return;
    document.querySelectorAll('.filter-chip').forEach(el => el.classList.remove('active'));
    if(btn) btn.classList.add('active');
    CURRENT_FILTER = type;
    this.render();
  },

  search() { this.render(); },

  decideMember(rowIndex, action) {
    if(!confirm(`Confirm ${action}?`)) return;
    const formData = new URLSearchParams();
    formData.append('action', action); 
    formData.append('row', rowIndex);
    if(action === 'delete') formData.append('sheet', 'Pending'); 

    fetch(CONFIG.API_URL, { method: 'POST', body: formData })
        .then(r => r.json())
        .then(() => { this.fetchData(); alert('Success'); });
  },

  openEdit(rowIndex, name, phone, plan, amount) {
    document.getElementById('edit-row').value = rowIndex;
    document.getElementById('edit-name').value = name;
    document.getElementById('edit-phone').value = phone;
    document.getElementById('edit-plan').value = plan;
    document.getElementById('edit-amount').value = amount;
    document.getElementById('edit-modal').style.display = 'flex';
  },

  saveEdit() {
    const formData = new URLSearchParams();
    formData.append('action', 'edit');
    formData.append('row', document.getElementById('edit-row').value);
    formData.append('Name', document.getElementById('edit-name').value);
    formData.append('Phone', document.getElementById('edit-phone').value);
    formData.append('Plan', document.getElementById('edit-plan').value);
    formData.append('Amount', document.getElementById('edit-amount').value);

    fetch(CONFIG.API_URL, { method: 'POST', body: formData }).then(() => {
       document.getElementById('edit-modal').style.display = 'none';
       this.fetchData();
    });
  },

  deleteRow(rowIndex, name) {
    if(!confirm(`Delete ${name}?`)) return;
    const formData = new URLSearchParams();
    formData.append('action', 'delete');
    formData.append('row', rowIndex);
    formData.append('sheet', 'Approved'); 
    fetch(CONFIG.API_URL, { method: 'POST', body: formData }).then(() => { this.fetchData(); });
  },

  render() {
    const term = document.getElementById("search").value.toLowerCase().trim();
    const tbody = document.getElementById("table-body");
    const thead = document.getElementById("table-head");
    
    if(CURRENT_MODE === 'requests') {
        let list = PENDING_DATA;
        if(list.length === 0) { tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:40px; color:#666;">No Pending Requests</td></tr>`; return; }
        
        thead.innerHTML = `<tr><th>Date</th><th>Name</th><th>Plan</th><th>Contact</th><th>Action</th></tr>`;
        tbody.innerHTML = list.map(item => `
            <tr class="hist-view">
                <td>${item.date}</td><td>${item.name}</td><td>${item.plan}</td><td>${item.phone}</td><td></td>
                <td>
                    <div class="action-group">
                        <button class="btn-icon btn-approve" onclick="App.decideMember(${item.rowIndex}, 'approve')"><i class="fas fa-check"></i></button>
                        <button class="btn-icon btn-reject" onclick="App.decideMember(${item.rowIndex}, 'delete')"><i class="fas fa-times"></i></button>
                    </div>
                </td>
            </tr>`).join("");
        return;
    }

    let list = APPROVED_DATA;
    if(CURRENT_MODE === 'dashboard') {
        const unique = []; const map = new Map();
        for (const item of list) { if(!map.has(item.phone)){ map.set(item.phone, true); unique.push(item); }}
        list = unique;
        if(CURRENT_FILTER === 'active') list = list.filter(i => i.days >= 0);
        else if(CURRENT_FILTER === 'soon') list = list.filter(i => i.days >= 0 && i.days <= 7);
        else if(CURRENT_FILTER === 'expired') list = list.filter(i => i.days < 0);
    }
    
    if(term) list = list.filter(i => (i.name && i.name.toLowerCase().includes(term)) || (i.phone && i.phone.includes(term)));
    
    if(list.length === 0) { tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:30px; color:#666;">No records found</td></tr>`; return; }

    if(CURRENT_MODE === 'dashboard') {
        thead.innerHTML = `<tr><th>Date</th><th>Name</th><th>Phone</th><th>Plan</th><th>Status</th><th>Action</th></tr>`;
        tbody.innerHTML = list.map(item => {
            let badge = item.days < 0 ? "b-expired" : (item.days <= 7 ? "b-soon" : "b-active");
            let status = item.days < 0 ? "Expired" : `${item.days} Days Left`;
            return `<tr class="dash-view">
                <td>${item.date}</td><td>${item.name}</td><td>${item.phone||"No Phone"}</td><td>${item.plan}</td>
                <td><span class="badge ${badge}">${status}</span></td>
                <td>${item.phone ? `<a href="https://wa.me/91${item.phone}?text=Hello ${item.name}, your membership status: ${status}" target="_blank" class="btn-wa"><i class="fab fa-whatsapp"></i></a>` : ""}</td>
            </tr>`;
        }).join("");
    } else {
        thead.innerHTML = `<tr><th>Date</th><th>Name</th><th>Phone</th><th>Plan</th><th>Amount</th><th>Action</th></tr>`;
        tbody.innerHTML = list.map(item => `
            <tr class="hist-view">
                <td>${item.date}</td><td>${item.name}</td><td>${item.phone||""}</td><td>${item.plan}</td><td>₹${item.amount}</td>
                <td>
                    <div class="action-group">
                        <button class="btn-icon btn-edit" onclick="App.openEdit(${item.rowIndex}, '${item.name}', '${item.phone}', '${item.plan}', '${item.amount}')"><i class="fas fa-pen"></i></button>
                        <button class="btn-icon btn-delete" onclick="App.deleteRow(${item.rowIndex}, '${item.name}')"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>`).join("");
    }
  }
};
</script>
</body>
</html>
