<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Chandu Fitness Admin</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  
  <style>
    /* ── STYLES (Kept Compact) ── */
    :root { --primary:#ff3b3b; --bg:#000; --card-bg:#121212; --border:#222; --text:#fff; }
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body { background:var(--bg); color:var(--text); font-family:'Montserrat', sans-serif; min-height:100vh; display:flex; flex-direction:column; }
    
    #login-overlay { position:fixed; inset:0; background:#000; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; background-image:radial-gradient(circle at center, #1a0505 0%, #000 70%); }
    .login-box { background:rgba(20,20,20,0.9); border:1px solid var(--border); padding:40px; border-radius:24px; text-align:center; width:85%; max-width:340px; backdrop-filter:blur(10px); }
    .pin-input { width:100%; padding:15px; margin:30px 0; background:#000; border:1px solid #333; color:#fff; text-align:center; font-size:1.8rem; letter-spacing:10px; border-radius:12px; outline:none; }
    .btn-main { width:100%; padding:16px; background:var(--primary); color:#fff; border:none; border-radius:12px; font-weight:700; font-family:'Oswald', sans-serif; cursor:pointer; }
    
    .header { position:sticky; top:0; z-index:100; background:rgba(5,5,5,0.85); backdrop-filter:blur(12px); padding:15px 20px; border-bottom:1px solid var(--border); display:flex; flex-direction:column; gap:15px; }
    .logo-bar { display:flex; align-items:center; justify-content:space-between; }
    .app-logo { font-family:'Oswald', sans-serif; font-size:1.3rem; color:white; }
    .search-bar { width:100%; padding:14px; border-radius:14px; border:1px solid #333; background:#111; color:white; outline:none; }
    
    .tabs { display:flex; background:#111; padding:4px; border-radius:12px; border:1px solid #333; }
    .tab { flex:1; text-align:center; padding:10px; font-size:0.85rem; font-weight:600; color:#666; cursor:pointer; border-radius:8px; }
    .tab.active { background:#222; color:white; }
    .badge-count { background:var(--primary); color:white; font-size:0.6rem; padding:2px 6px; border-radius:10px; margin-left:5px; display:none; }
    
    .content-wrapper { flex:1; padding:20px; }
    .stats { display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-bottom:25px; }
    .stat-card { background:#151515; padding:16px; border-radius:16px; text-align:center; border:1px solid var(--border); }
    .stat-val { font-family:'Oswald', sans-serif; font-size:1.4rem; color:white; }
    .stat-label { font-size:0.65rem; color:#666; }
    
    /* Table & Cards */
    table { width:100%; border-collapse:separate; border-spacing:0 12px; }
    tbody tr { background:var(--card-bg); }
    tbody td { padding:16px; border-top:1px solid var(--border); border-bottom:1px solid var(--border); color:#ccc; }
    tbody tr td:first-child { border-left:1px solid var(--border); border-top-left-radius:14px; border-bottom-left-radius:14px; }
    tbody tr td:last-child { border-right:1px solid var(--border); border-top-right-radius:14px; border-bottom-right-radius:14px; }
    
    .approval-card { background:#151515; border:1px solid #333; border-radius:12px; padding:20px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center; }
    .appr-info strong { color:white; display:block; margin-bottom:5px; }
    .appr-info span { color:#888; font-size:0.9rem; display:block; }
    .appr-actions { display:flex; gap:10px; }
    .btn-approve { background:#28a745; color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:bold; cursor:pointer; }
    .btn-reject { background:#dc3545; color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:bold; cursor:pointer; }
    .btn-wa { color:#25d366; font-size:1.4rem; }

    @media (max-width: 768px) {
      .stats { display:flex; overflow-x:auto; gap:12px; }
      .stat-card { min-width:130px; }
      thead { display:none; }
      tr { display:block; margin-bottom:16px; padding:18px; border:1px solid #222; border-radius:18px; position:relative; }
      td { display:block; padding:0; border:none!important; }
      .approval-card { flex-direction:column; align-items:flex-start; gap:15px; }
      .appr-actions { width:100%; } .btn-approve, .btn-reject { flex:1; }
      
      /* Mobile Rows */
      .dash-view td:nth-child(2) { font-size:1.25rem; font-weight:700; color:#fff; margin-bottom:4px; font-family:'Oswald', sans-serif; }
      .dash-view td:nth-child(3) { color:#666; font-size:0.9rem; margin-bottom:12px; }
      .dash-view td:nth-child(4) { display:inline-block; background:#1a1a1a; padding:4px 10px; border-radius:6px; color:var(--primary); font-size:0.8rem; }
      .dash-view td:nth-child(1) { position:absolute; top:18px; right:70px; font-size:0.75rem; color:#555; }
      .dash-view td:nth-child(6) { position:absolute; top:15px; right:15px; }
    }
  </style>
</head>
<body>

  <div id="login-overlay">
    <div class="login-box">
      <div class="login-logo">CHANDHU<span>FITNESS</span></div>
      <p style="color:#666; font-size:0.8rem; margin-bottom:20px;">SECURE ADMIN PANEL</p>
      <input type="password" id="pin-input" class="pin-input" placeholder="••••" maxlength="4" inputmode="numeric">
      <button class="btn-main" onclick="Auth.login()">ACCESS DASHBOARD</button>
      <p id="error-msg" style="color:var(--primary); margin-top:20px; font-size:0.9rem; display:none">Incorrect PIN</p>
    </div>
  </div>

  <div class="main">
    <header class="header">
      <div class="logo-bar">
        <div class="app-logo"><i class="fas fa-dumbbell"></i> CHANDHU FITNESS</div>
      </div>
      <div class="tabs">
        <div class="tab active" onclick="App.setMode('dashboard', this)">Dashboard</div>
        <div class="tab" onclick="App.setMode('approvals', this)">Approvals <span id="badge-pending" class="badge-count">0</span></div>
      </div>
    </header>

    <div class="content-wrapper">
      <div id="stats-container" class="stats">
        <div class="stat-card"><div class="stat-val" style="color:var(--primary)">₹<span id="stat-revenue">0</span></div><div class="stat-label">Total Revenue</div></div>
        <div class="stat-card"><div class="stat-val" id="stat-total">0</div><div class="stat-label">Total Members</div></div>
        <div class="stat-card"><div class="stat-val" style="color:var(--warning)" id="stat-soon">0</div><div class="stat-label">Expiring Soon</div></div>
      </div>

      <div id="loader" style="text-align:center; padding:60px; color:#444">
        <i class="fas fa-circle-notch fa-spin fa-2x"></i><br><br>Syncing Database...
      </div>

      <div id="approvals-container" style="display:none"></div>

      <table id="data-table" style="display:none">
        <thead id="table-head"></thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </div>

<script>
const CONFIG = {
    // ⚠️ RE-DEPLOY YOUR SCRIPT AND PASTE THE NEW URL HERE
    API_URL: "https://script.google.com/macros/s/AKfycbx-2znQf8ysCS-QJMxUSGYyIKZUbIu6XSq9NtGVcOS-pbs42oJx69i6a9BcfR5nS5i_pw/exec",
    PIN_HASH: "1509442" // Hash for 1234
};

let RAW_DATA = []; let SMART_DATA = []; let PENDING_DATA = []; let CURRENT_MODE = 'dashboard';

const Auth = {
    login() {
        const input = document.getElementById('pin-input').value;
        const hash = this.generateHash(input);
        if(hash === CONFIG.PIN_HASH) {
            document.getElementById('login-overlay').style.display = 'none';
            App.fetchData();
        } else {
            document.getElementById('error-msg').style.display = 'block';
        }
    },
    generateHash(str) {
        let hash = 0; if (str.length === 0) return hash.toString();
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i); hash = ((hash << 5) - hash) + char; hash = hash & hash;
        } return hash.toString();
    }
};

const App = {
  fetchData() {
    document.getElementById("loader").style.display = "block";
    
    // 1. Fetch Main Data
    fetch(CONFIG.API_URL)
      .then(r => {
          if(!r.ok) throw new Error("Script URL is wrong or permissions denied");
          return r.json();
      })
      .then(data => {
        // Process Main Data
        const rows = data.data.slice(1);
        RAW_DATA = rows.map((r, i) => ({
            date: r[0], name: r[1], phone: r[2] ? String(r[2]) : "", 
            plan: r[3], amount: parseInt(r[4]) || 0, days: parseInt(r[7]) || 0 
        })).filter(i => i.name && i.name.trim() !== "");
        
        RAW_DATA.sort((a,b) => new Date(b.date) - new Date(a.date));
        
        // Remove Duplicates for Stats
        const uniqueMap = new Map(); SMART_DATA = [];
        RAW_DATA.forEach(item => {
            if(!item.phone || !uniqueMap.has(item.phone)) { 
                uniqueMap.set(item.phone, true); SMART_DATA.push(item); 
            }
        });

        this.updateStats();
        
        // 2. Fetch Pending Data
        return fetch(CONFIG.API_URL + "?action=getPending");
      })
      .then(r => r.json())
      .then(pending => {
          // SAFE FILTERING: Check if it's an array first
          if (Array.isArray(pending)) {
              PENDING_DATA = pending.filter(user => user && user.Name && user.Phone);
              PENDING_DATA.reverse(); // Newest First
          } else {
              PENDING_DATA = [];
          }

          // Update Badge
          const badge = document.getElementById('badge-pending');
          badge.style.display = PENDING_DATA.length > 0 ? 'inline-block' : 'none';
          badge.innerText = PENDING_DATA.length;
          
          document.getElementById("loader").style.display = "none";
          this.render();
      })
      .catch(e => {
          console.error(e);
          alert("Error: " + e.message + "\n\nTip: Did you Deploy > New Version in Google Script?");
          document.getElementById("loader").style.display = "none";
      });
  },

  updateStats() {
    document.getElementById("stat-revenue").innerText = RAW_DATA.reduce((s, i) => s + i.amount, 0).toLocaleString();
    document.getElementById("stat-total").innerText = SMART_DATA.length;
    document.getElementById("stat-soon").innerText = SMART_DATA.filter(i => i.days >= 0 && i.days <= 7).length;
  },

  setMode(mode, btn) {
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    btn.classList.add('active');
    CURRENT_MODE = mode;
    
    document.getElementById('stats-container').style.display = (mode === 'dashboard') ? 'grid' : 'none';
    this.render();
  },

  processApproval(id, action, btn) {
    if(!confirm(`Confirm ${action}?`)) return;
    btn.innerText = "..."; btn.disabled = true;
    
    const formData = new FormData();
    formData.append("action", action);
    formData.append("id", id);
    
    fetch(CONFIG.API_URL, { method: "POST", body: formData })
        .then(r => r.text())
        .then(res => {
            alert(res);
            this.fetchData();
        })
        .catch(e => alert("Error: " + e));
  },

  render() {
    const tbody = document.getElementById("table-body");
    const appContainer = document.getElementById("approvals-container");
    const tableContainer = document.getElementById("data-table");
    
    if(CURRENT_MODE === 'approvals') {
        tableContainer.style.display = 'none';
        appContainer.style.display = 'block';
        
        if(PENDING_DATA.length === 0) {
            appContainer.innerHTML = `<div style="text-align:center; padding:40px; color:#666">No pending approvals</div>`;
            return;
        }

        appContainer.innerHTML = PENDING_DATA.map(user => `
            <div class="approval-card">
                <div class="appr-info">
                    <strong>${user.Name}</strong>
                    <span>${user.Phone} | ₹${user.Amount} (${user.Plan})</span>
                    <span style="font-size:0.8rem; margin-top:5px; color:#555">Date: ${new Date(user.Date).toLocaleDateString()}</span>
                </div>
                <div class="appr-actions">
                    <button class="btn-approve" onclick="App.processApproval('${user.uid}', 'approve', this)">✔</button>
                    <button class="btn-reject" onclick="App.processApproval('${user.uid}', 'reject', this)">✖</button>
                </div>
            </div>
        `).join("");
        return;
    }

    // Dashboard Mode
    appContainer.style.display = 'none';
    tableContainer.style.display = 'table';
    document.getElementById("table-head").innerHTML = `<tr><th>Date</th><th>Name</th><th>Phone</th><th>Plan</th><th>Status</th><th>Action</th></tr>`;
    
    tbody.innerHTML = RAW_DATA.map(item => {
        let badge = item.days < 0 ? "b-expired" : (item.days <= 7 ? "b-soon" : "b-active");
        let status = item.days < 0 ? "Expired" : `${item.days} Days Left`;
        let dateStr = "N/A"; try { dateStr = new Date(item.date).toLocaleDateString('en-IN', {day:'numeric', month:'short'}); } catch(e){}
        return `<tr class="dash-view">
            <td>${dateStr}</td><td>${item.name}</td><td>${item.phone}</td><td>${item.plan}</td>
            <td><span class="badge ${badge}">${status}</span></td>
            <td><a href="https://wa.me/91${item.phone}" target="_blank" class="btn-wa"><i class="fab fa-whatsapp"></i></a></td>
        </tr>`;
    }).join("");
  }
};
</script>
</body>
</html>
